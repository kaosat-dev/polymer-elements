<link rel="import" href="../../vendor/polymer-ui-elements/polymer-ui-collapsible/polymer-ui-collapsible.html">
<link rel="import" href="../../vendor/polymer-ui-elements/polymer-ui-icon-button/polymer-ui-icon-button.html">
<link rel="import" href="../../vendor/polymer-ui-elements/polymer-ui-icon/polymer-ui-icon.html">
<link rel="import" href="../../vendor/polymer-elements/polymer-selector/polymer-selector.html">

<polymer-element name="polymer-ui-collapsible2" extends="polymer-ui-collapsible">
	<script>
    Polymer('polymer-ui-collapsible2', {
		activeChanged:function()
		{
			//console.log("active", this.active);
			if(this.active)
			{
				this.fire('activated', this.active);
			}
			else
			{
				this.fire('deactivated', this.active);
			}
		}
    });
  </script>
</polymer-element>

<!--Single list of files
 - click on item : if folder, load data (asynch) then display
 - click on open item : collapse


<polymer-selector selected="0">
  <div>Item 1</div>
  <div>Item 2</div>
  <div>Item 3</div>
</polymer-selector>
-->
<polymer-element name="file-list" attributes="elements">
	<template repeat="{{items}}" id="t" >

	</template>
	<script>
    Polymer('file-list', {
		
		activeChanged:function()
		{
			//console.log("active", this.active);
			this.fire('activated', this.active);
		}
    });
  </script>
</polymer-element>

<polymer-element name="file-folder" attributes="name type subElements">
	<style>
		@host {
	  		* {display: block;}
	  	}
	</style>
	<template>
		<span>
			<template if="{{ type == 'folder' && subElements.length>0}}">
				<polymer-ui-icon-button icon="plus" ></polymer-ui-icon-button>
			</template>
			<template if="{{ type == 'folder' && subElements.length==0}}">
				<polymer-ui-icon-button icon="twitter" ></polymer-ui-icon-button>
			</template>
			<template if="{{ type == 'file' }}">
				<polymer-ui-icon-button icon="menu" enabled=false ></polymer-ui-icon-button>
			</template>
			{{name}}
		</span>
	</template>
	<script>
    Polymer('file-folder', {
		type:'file',
		name:'file.txt',
		subElements: [],
		ready: function() {
			console.log("subElements",this.subElements);
		}
    });
  </script>
</polymer-element>


<polymer-element name="adress-bar" attributes="path">
	<style>
	 	.pathComponent
		{
			color:blue;
			cursor:pointer;
		}
	</style>
	<template>
		<template id="pathComponents" repeat="{{_pathComponents}}">
			<span class="pathComponent" on-click="pathComponentClicked">{{name}}</span>/
		</template>
	</template>
	<script>
	Polymer('adress-bar', {
		path:"/home/test/dev/bla/bli",
		ready: function() {
			this.generatePathComponents();
		},
		created: function() {},
    generatePathComponents:function(){
      var pathComponents = this.path.split("/");
      this._pathComponents = []
      for (var i=0; i< pathComponents.length;i++)
      {
        var name = pathComponents[i];
        var pathList = pathComponents.slice(0,i+1);
        var path = pathList.join('/')
        this._pathComponents.push({name:name, path:path, index:i});
      }
    },
		pathComponentClicked:function(event, detail, sender){
      var model = sender.templateInstance_.model;
      var targetPath = model.path;
      console.log("please navigate to "+targetPath);
      targetPathComponents = this._pathComponents.slice(0,model.index+1);
      //TODO: don't replace path components just use a subset for display ??
      this.async(function(){
        //console.log("bla",this._pathComponents.length ,"blo", targetPathComponents.length);
        if(this._pathComponents.length+1 != targetPathComponents.length)
        {
          this._pathComponents = targetPathComponents;
          this.path = targetPath;
          //this.fire('pathChanged', {msg: 'That hurt!'}); 
        }
      });      

		}
	});
	</script>
</polymer-element>

<polymer-element name="file-browser" attributes="rootpath">
	<style>
		@host {
	  * {
		display: inline-block;
		
	  }
	
	}
	ul {list-style: none;}
	li {list-style: none;}
	.item.polymer-selected
	{
		background: #eee;
	}
	</style>
	<template>
		<div id="container" style="width:400px;">
			<adress-bar></adress-bar>
			<polymer-selector>
			<template repeat="{{items}}" id="t" >
				<li class="item">
					<polymer-ui-collapsible2 on-activated="bleh" on-deactivated="blah">
  						<div class="polymer-ui-collapsible-header" ><file-folder type="{{type}}" name="{{name}}" subElements="{{children}}"> </file-folder></div>
  						<div>
							<ul id="childElems" >
					  			<template ref="t" repeat="{{ children }}" ></template>
							</ul>
  						</div>
					</polymer-ui-collapsible2>
			    </li>
			</template>
			</polymer-selector>
		</div>
    </template>

  <script>
	
    Polymer('file-browser', {
		rootpath:"toto",
		items:[{name:"rootFolder"}],
		ready: function() {console.log("file browser ready"); },
		created: function() {console.log("file browser created"); },
  		enteredView: function () { console.log("file browser entered view");},
  		leftView: function() { console.log("file browser left view"); },
		bleh:function(src,state)
		{
			//console.log("children", this);
			console.log("activated",state, src);
			this.fetchData(); 
		},
		blah:function(src,state)
		{
			//console.log("children", this);
			console.log("DE-activated",state, src);
		},
		fetchData:function(path)
		{
			this.async(function() {
				items= [{
				'name': 'folder1',
				'type':'folder',
				'children':[{'name':'someThing.fa'},{name:'bli.fastq'}]
			  	}];
				
		

				if(this.items[0].children != items)
				{
					this.items[0].children = items;
				}
				console.log("blah");
				console.log("this",this);
			}, null, 1000);


		}
		
    });
  </script>
</polymer-element>

